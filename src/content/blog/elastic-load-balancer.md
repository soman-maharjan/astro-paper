---
title: Elastic Load Balancer
author: Soman Maharjan
pubDatetime: 2024-05-07T10:35:31Z
slug: elastic-load-balancer
featured: true
draft: false
tags:
  - LoadBalancer
  - HealthCheck
  - StickySession
  - Connection
  - ConnectionDraining
description: Load Balances are servers that forward traffic to multiple servers (e.g., EC2 instances) downstream.
---

## Table of contents

## Why use it?

![elastic-load-balancer](@assets/images/elb.png)

- Spread load across multiple downstream instances
- Expose a single point of access (DNS) to your application • Seamlessly handle failures of downstream instances
- Do regular health checks to your instances
- Provide SSL termination (HTTPS) for your websites
- Enforce stickiness with cookies
- High availability across zones
- Separate public traffic from private traffic

## Health Checks

It enables load balancer to know if instances it forwards traffic to are available to reply to requests.  
The health check is done on a port and a route. (/health is common)
If the response is not 200 (OK), then the instance is unhealthy.
![health-check](@assets/images/health-check.png)

## Types

1. Classic Load Balancer (CLB) - Discontinued
2. Application Load Balancer (ALB)
   HTTP, HTTPS,WebSocket
3. Network Load Balancer (NLB)
   TCP,TLS(secureTCP),UDP
4. Gateway Load Balancer (GWLB)
   Operates at layer 3 (Network layer) – IP Protocol
   Route all traffic through single entry and exit. Used for security applications like firewall or packet manipulation.
   Port: 6081
   Protocol: GENEVE

### Application Load Balancer

- Path in URL (example.com/users & example.com/posts)
- Hostname in URL (one.example.com & other.example.com)
- Query String, Headers (example.com/users?id=123&order=false)

ALB are great for micro services & container-based application (example: Docker & Amazon ECS)
Has a port mapping feature to redirect to a dynamic port in ECS.
The application servers don’t see the IP of the client directly:

- The true IP of the client is inserted in the header X-Forwarded-For
- We can also get Port (X-Forwarded-Port) and proto (X-Forwarded-Proto)

![alb](@assets/images/alb.png)

### Gateway Load Balancer

It's like a firewall for traffic before sending traffic to destination. Every request passes through the target group before it reaches the destination.

Example: Firewalls, Intrusion Detection and Prevention Systems, Deep Packet Inspection Systems, payload manipulation.

- Layer 3 (Network Layer) – IP Packets
  Combines the following functions:
- Transparent Network Gateway – single
- Load Balancer – distributes traffic to virtual appliances

![glb](@assets/images/glb.png)

## Load Balancer Security Groups

Security Group can be used to define inbound/outbound traffic for load balancer and target groups.

Load balancer can take HTTP/HTTPS traffic from anywhere and target groups can only take traffic from load balancer. This prevents direct access to target groups.
![lbsg](@assets/images/lbsg.png)

## Sticky Sessions

It means to let the same instance handle request of a particular user using load balancer. Do not assign new instance.

**Cookie Types**

1. Application-based Cookies
   - Custom cookie
     - Generated by the target
     - Can include any custom attributes required by the application
     - Cookie name must be specified individually for each target group
     - Don’t use AWSALB, AWSALBAPP, or AWSALBTG (reserved for use by the ELB)
   - Application cookie
     - Generated by the load balancer
     - Cookie name is AWSALBAPP
2. Duration-based Cookies
   - Cookie generated by the load balancer
   - Cookie name is AWSALB for ALB, AWSELB for CLB
     ![sticky-session](@assets/images/sticky-session.png)

## Cross zone load balancing

Load balancing between multiple AZ.
Enabled for ALB by default and can be disabled at Target group level.
Disabled for NLB and GWLB, and is not free.

![cross-zone-load-balancing](@assets/images/cross-zone-load-balancing.png)

## Connection Draining

Its a feature that waits for an EC2 instance (lets say Instance A) to complete existing connections before removing it from the pool. ELB then removes the instance A and establishes new connections to all other instances except Instance A.

Time to complete “in-flight requests” while the instance is de-registering or unhealthy
![connection-draining](@assets/images/connection-draining.png)
